// SPDX-License-Identifier: LGPL-3.0-or-later

#include <core/kernel/vge/fb_render.h>
#include <lib/bootloader/limine.h>
#include <stdint.h>
#include <stddef.h>
#include <stdbool.h>

#define FONT_HEIGHT 16

extern int system_font_height;
extern uint8_t system_font[256][FONT_HEIGHT];

volatile struct limine_framebuffer_request fb_request = {
    .id = LIMINE_FRAMEBUFFER_REQUEST_ID,
    .revision = 0,
    .response = NULL
};

static struct {
    struct limine_framebuffer *fb;
    uint32_t *fb_addr;
    uint64_t width;
    uint64_t height;
    uint64_t pitch;
    uint64_t pitch_pixels;
    uint32_t bg_color;
    uint32_t fg_color;
    uint32_t cursor_x;
    uint32_t cursor_y;
    uint32_t char_width;
    uint32_t char_height;
    bool initialized;
} fb_info = {0};

// Built-in fallback font (used when system_font is not loaded)
const uint8_t builtin_font[256][8] = {
    [0x00 ... 0x1F] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    [' ']  = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    ['!']  = {0x18,0x18,0x18,0x18,0x00,0x00,0x18,0x00},
    [',']  = {0x00,0x00,0x00,0x00,0x18,0x18,0x30,0x00},
    ['-']  = {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00},
    ['.']  = {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00},
    ['0']  = {0x3C,0x66,0x6E,0x76,0x66,0x66,0x3C,0x00},
    ['1']  = {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00},
    ['2']  = {0x3C,0x66,0x06,0x0C,0x18,0x30,0x7E,0x00},
    ['3']  = {0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00},
    ['4']  = {0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x00},
    ['5']  = {0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00},
    ['6']  = {0x3C,0x60,0x60,0x7C,0x66,0x66,0x3C,0x00},
    ['7']  = {0x7E,0x06,0x0C,0x18,0x30,0x30,0x30,0x00},
    ['8']  = {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00},
    ['9']  = {0x3C,0x66,0x66,0x3E,0x06,0x06,0x3C,0x00},
    [':']  = {0x00,0x00,0x18,0x18,0x00,0x18,0x18,0x00},
    [';']  = {0x00,0x00,0x18,0x18,0x00,0x18,0x18,0x30},
    ['<']  = {0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00},
    ['>']  = {0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00},
    ['?']  = {0x3C,0x66,0x0C,0x18,0x18,0x00,0x18,0x00},
    ['A']  = {0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00},
    ['B']  = {0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00},
    ['C']  = {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00},
    ['D']  = {0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00},
    ['E']  = {0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0x00},
    ['F']  = {0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x00},
    ['G']  = {0x3C,0x66,0x60,0x6E,0x66,0x66,0x3C,0x00},
    ['H']  = {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00},
    ['I']  = {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    ['J']  = {0x1E,0x0C,0x0C,0x0C,0x0C,0x6C,0x38,0x00},
    ['K']  = {0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00},
    ['L']  = {0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00},
    ['M']  = {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00},
    ['N']  = {0x66,0x76,0x7E,0x7E,0x6E,0x66,0x66,0x00},
    ['O']  = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00},
    ['P']  = {0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00},
    ['Q']  = {0x3C,0x66,0x66,0x66,0x66,0x3C,0x0E,0x00},
    ['R']  = {0x7C,0x66,0x66,0x7C,0x78,0x6C,0x66,0x00},
    ['S']  = {0x3C,0x66,0x60,0x3C,0x06,0x66,0x3C,0x00},
    ['T']  = {0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00},
    ['U']  = {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00},
    ['V']  = {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00},
    ['W']  = {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00},
    ['X']  = {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00},
    ['Y']  = {0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x00},
    ['Z']  = {0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00},
    ['a']  = {0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00},
    ['b']  = {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00},
    ['c']  = {0x00,0x00,0x3C,0x60,0x60,0x60,0x3C,0x00},
    ['d']  = {0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00},
    ['e']  = {0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00},
    ['f']  = {0x1C,0x30,0x30,0x7C,0x30,0x30,0x30,0x00},
    ['g']  = {0x00,0x00,0x3E,0x66,0x3E,0x06,0x3C,0x00},
    ['h']  = {0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x00},
    ['i']  = {0x00,0x18,0x00,0x38,0x18,0x18,0x3C,0x00},
    ['j']  = {0x0C,0x00,0x0C,0x0C,0x0C,0x6C,0x38,0x00},
    ['k']  = {0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00},
    ['l']  = {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    ['m']  = {0x00,0x00,0x66,0x7F,0x7F,0x6B,0x63,0x00},
    ['n']  = {0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00},
    ['o']  = {0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00},
    ['p']  = {0x00,0x00,0x7C,0x66,0x7C,0x60,0x60,0x00},
    ['q']  = {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06},
    ['r']  = {0x00,0x00,0x7C,0x66,0x60,0x60,0x60,0x00},
    ['s']  = {0x00,0x00,0x3C,0x60,0x3C,0x06,0x7C,0x00},
    ['t']  = {0x00,0x18,0x18,0x7E,0x18,0x18,0x0E,0x00},
    ['u']  = {0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00},
    ['v']  = {0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00},
    ['w']  = {0x00,0x00,0x63,0x6B,0x7F,0x3E,0x36,0x00},
    ['x']  = {0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00},
    ['y']  = {0x00,0x00,0x66,0x66,0x3E,0x06,0x7C,0x00},
    ['z']  = {0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00},
    [0xA8] = {0x66,0x7E,0x60,0x60,0x7C,0x60,0x7E,0x00},
    [0xC0] = {0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00},
    [0xC1] = {0x7C,0x60,0x60,0x7C,0x66,0x66,0x7C,0x00},
    [0xC2] = {0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00},
    [0xC3] = {0x7E,0x60,0x60,0x60,0x60,0x60,0x60,0x00},
    [0xC4] = {0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00},
    [0xC5] = {0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0x00},
    [0xC6] = {0x6B,0x6B,0x3E,0x1C,0x3E,0x6B,0x6B,0x00},
    [0xC7] = {0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00},
    [0xC8] = {0x66,0x66,0x6E,0x7E,0x76,0x66,0x66,0x00},
    [0xC9] = {0x18,0x66,0x6E,0x7E,0x76,0x66,0x66,0x00},
    [0xCA] = {0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00},
    [0xCB] = {0x1E,0x36,0x66,0x66,0x66,0x66,0x66,0x00},
    [0xCC] = {0x63,0x77,0x7F,0x6B,0x63,0x63,0x63,0x00},
    [0xCD] = {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00},
    [0xCE] = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00},
    [0xCF] = {0x7E,0x66,0x66,0x66,0x66,0x66,0x66,0x00},
    [0xD0] = {0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00},
    [0xD1] = {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00},
    [0xD2] = {0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00},
    [0xD3] = {0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x00},
    [0xD4] = {0x18,0x7E,0xDB,0xDB,0x7E,0x18,0x18,0x00},
    [0xD5] = {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00},
    [0xD6] = {0x66,0x66,0x66,0x66,0x66,0x7E,0x06,0x00},
    [0xD7] = {0x66,0x66,0x66,0x3E,0x06,0x06,0x06,0x00},
    [0xD8] = {0x6B,0x6B,0x6B,0x6B,0x6B,0x6B,0x7F,0x00},
    [0xD9] = {0x6B,0x6B,0x6B,0x6B,0x6B,0x7F,0x03,0x00},
    [0xDA] = {0x70,0x30,0x3C,0x36,0x36,0x36,0x3C,0x00},
    [0xDB] = {0x63,0x63,0x63,0x7B,0x6F,0x6F,0x7B,0x00},
    [0xDC] = {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00},
    [0xDD] = {0x3C,0x66,0x06,0x1E,0x06,0x66,0x3C,0x00},
    [0xDE] = {0x6E,0x6B,0x6B,0x7B,0x6B,0x6B,0x6E,0x00},
    [0xDF] = {0x3E,0x66,0x66,0x3E,0x16,0x26,0x66,0x00},
    [0xB8] = {0x66,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00},
    [0xE0] = {0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00},
    [0xE1] = {0x1C,0x30,0x60,0x7C,0x66,0x66,0x7C,0x00},
    [0xE2] = {0x00,0x00,0x7C,0x66,0x7C,0x66,0x7C,0x00},
    [0xE3] = {0x00,0x00,0x7E,0x60,0x60,0x60,0x60,0x00},
    [0xE4] = {0x00,0x00,0x1E,0x36,0x66,0x66,0x7F,0x00},
    [0xE5] = {0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00},
    [0xE6] = {0x00,0x00,0x6B,0x3E,0x1C,0x3E,0x6B,0x00},
    [0xE7] = {0x00,0x00,0x3C,0x06,0x1C,0x06,0x3C,0x00},
    [0xE8] = {0x00,0x00,0x66,0x6E,0x7E,0x76,0x66,0x00},
    [0xE9] = {0x18,0x00,0x66,0x6E,0x7E,0x76,0x66,0x00},
    [0xEA] = {0x00,0x00,0x66,0x6C,0x78,0x6C,0x66,0x00},
    [0xEB] = {0x00,0x00,0x1E,0x36,0x66,0x66,0x66,0x00},
    [0xEC] = {0x00,0x00,0x63,0x77,0x7F,0x6B,0x63,0x00},
    [0xED] = {0x00,0x00,0x66,0x66,0x7E,0x66,0x66,0x00},
    [0xEE] = {0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00},
    [0xEF] = {0x00,0x00,0x7E,0x66,0x66,0x66,0x66,0x00},
    [0xF0] = {0x00,0x00,0x7C,0x66,0x7C,0x60,0x60,0x00},
    [0xF1] = {0x00,0x00,0x3C,0x66,0x60,0x66,0x3C,0x00},
    [0xF2] = {0x00,0x00,0x7E,0x18,0x18,0x18,0x18,0x00},
    [0xF3] = {0x00,0x00,0x66,0x66,0x3E,0x06,0x3C,0x00},
    [0xF4] = {0x00,0x18,0x7E,0xDB,0x7E,0x18,0x18,0x00},
    [0xF5] = {0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00},
    [0xF6] = {0x00,0x00,0x66,0x66,0x66,0x7E,0x06,0x00},
    [0xF7] = {0x00,0x00,0x66,0x66,0x3E,0x06,0x06,0x00},
    [0xF8] = {0x00,0x00,0x6B,0x6B,0x6B,0x6B,0x7F,0x00},
    [0xF9] = {0x00,0x00,0x6B,0x6B,0x6B,0x7F,0x03,0x00},
    [0xFA] = {0x00,0x70,0x30,0x3C,0x36,0x36,0x3C,0x00},
    [0xFB] = {0x00,0x00,0x63,0x63,0x7B,0x6F,0x7B,0x00},
    [0xFC] = {0x00,0x00,0x60,0x7C,0x66,0x66,0x7C,0x00},
    [0xFD] = {0x00,0x00,0x3C,0x06,0x1E,0x06,0x3C,0x00},
    [0xFE] = {0x00,0x00,0x6E,0x6B,0x7B,0x6B,0x6E,0x00},
    [0xFF] = {0x00,0x00,0x3E,0x66,0x3E,0x26,0x66,0x00},
    [0xB2] = {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    [0xB3] = {0x00,0x18,0x00,0x38,0x18,0x18,0x3C,0x00},
};

void init_fb(void) {
    if (fb_info.initialized) return;

    if (fb_request.response == NULL ||
        fb_request.response->framebuffer_count == 0) {
        return;
    }

    fb_info.fb = fb_request.response->framebuffers[0];
    fb_info.fb_addr = (uint32_t*)fb_info.fb->address;
    fb_info.width = fb_info.fb->width;
    fb_info.height = fb_info.fb->height;
    fb_info.pitch = fb_info.fb->pitch;
    fb_info.pitch_pixels = fb_info.pitch / 4;

    fb_info.char_width = 8;
    fb_info.char_height = 16;

    fb_info.bg_color = 0x00000000; // Черный
    fb_info.fg_color = 0x00FFFFFF; // Белый

    fb_info.cursor_x = 0;
    fb_info.cursor_y = 0;

    fb_info.initialized = true;

    clear_screen();
}

static void put_pixel(uint32_t x, uint32_t y, uint32_t color) {
    if (x >= fb_info.width || y >= fb_info.height) return;

    uint32_t *pixel = &fb_info.fb_addr[y * fb_info.pitch_pixels + x];
    *pixel = color;
}

static void draw_char(uint32_t x, uint32_t y, char c, uint32_t color) {
    if (c < 0 || c >= 128) return;

    const uint8_t *glyph = system_font[(int)c];

    int height_to_draw = system_font_height;
    if (height_to_draw > FONT_HEIGHT) {
        height_to_draw = FONT_HEIGHT;
    }

    for (int row = 0; row < height_to_draw; row++) {
        uint8_t row_data = glyph[row];
        for (uint32_t col = 0; col < 8; col++) {
            if (row_data & (1 << (7 - col))) {
                put_pixel(x + col, y + row, color);
            }
        }
    }
}

void clear_screen(void) {
    init_fb();

    for (uint32_t y = 0; y < fb_info.height; y++) {
        for (uint32_t x = 0; x < fb_info.width; x++) {
            put_pixel(x, y, fb_info.bg_color);
        }
    }

    fb_info.cursor_x = 0;
    fb_info.cursor_y = 0;
}

void newline(void) {
    init_fb();

    fb_info.cursor_x = 0;
    fb_info.cursor_y += fb_info.char_height;

    if (fb_info.cursor_y + fb_info.char_height > fb_info.height) {
        uint32_t scroll_lines = fb_info.char_height;
        uint32_t *src = &fb_info.fb_addr[scroll_lines * fb_info.pitch_pixels];
        uint32_t *dst = fb_info.fb_addr;
        uint64_t size = (fb_info.height - scroll_lines) * fb_info.pitch_pixels * 4;

        for (uint64_t i = 0; i < size / 4; i++) {
            dst[i] = src[i];
        }

        uint32_t last_line_start = (fb_info.height - scroll_lines) * fb_info.pitch_pixels;
        for (uint64_t i = 0; i < scroll_lines * fb_info.pitch_pixels; i++) {
            fb_info.fb_addr[last_line_start + i] = fb_info.bg_color;
        }

        fb_info.cursor_y = fb_info.height - fb_info.char_height;
    }
}

void putchar(char c, int color) {
    init_fb();

    if (c == '\n') {
        newline();
        return;
    }

    if (c == '\t') {
        fb_info.cursor_x += fb_info.char_width * 4;
        return;
    }

    if (fb_info.cursor_x + fb_info.char_width > fb_info.width) {
        newline();
    }

    uint32_t y_offset = (fb_info.char_height - system_font_height) / 2;
    if (y_offset < 0) y_offset = 0;

    draw_char(fb_info.cursor_x, fb_info.cursor_y + y_offset, c, color);

    fb_info.cursor_x += fb_info.char_width;
}

void vgaprint(const char *str, int color) {
    init_fb();

    uint32_t fb_color;

    switch (color & 0xF) {
        case 0: fb_color = 0x00000000; break;
        case 1: fb_color = 0x000000AA; break;
        case 2: fb_color = 0x0000AA00; break;
        case 3: fb_color = 0x0000AAAA; break;
        case 4: fb_color = 0x00AA0000; break;
        case 5: fb_color = 0x00AA00AA; break;
        case 6: fb_color = 0x00AA5500; break;
        case 7: fb_color = 0x00AAAAAA; break;
        case 8: fb_color = 0x00555555; break;
        case 9: fb_color = 0x005555FF; break;
        case 10: fb_color = 0x0055FF55; break;
        case 11: fb_color = 0x0055FFFF; break;
        case 12: fb_color = 0x00FF5555; break;
        case 13: fb_color = 0x00FF55FF; break;
        case 14: fb_color = 0x00FFFF55; break;
        case 15: fb_color = 0x00FFFFFF; break;
        default: fb_color = 0x00FFFFFF; break;
    }

    while (*str) {
        putchar(*str, fb_color);
        str++;
    }
}

void kprint(const char *str, int color) {
    vgaprint(str, color);
}

void set_bg_color(uint32_t color) {
    fb_info.bg_color = color;
}

void set_fg_color(uint32_t color) {
    fb_info.fg_color = color;
}

void vga_backspace(void) {
    init_fb();

    if (fb_info.cursor_x == 0) {
        return;
    }

    fb_info.cursor_x -= fb_info.char_width;

    uint32_t y_offset = (fb_info.char_height - system_font_height) / 2;
    if (y_offset < 0) y_offset = 0;

    draw_rect(fb_info.cursor_x, fb_info.cursor_y + y_offset,
              fb_info.char_width, system_font_height, fb_info.bg_color);
}

void set_cursor_pos(uint32_t x, uint32_t y) {
    init_fb();

    fb_info.cursor_x = x * fb_info.char_width;
    fb_info.cursor_y = y * fb_info.char_height;

    if (fb_info.cursor_x >= fb_info.width) fb_info.cursor_x = 0;
    if (fb_info.cursor_y >= fb_info.height) fb_info.cursor_y = 0;
}

uint32_t get_screen_width_chars(void) {
    init_fb();
    return fb_info.width / fb_info.char_width;
}

uint32_t get_screen_height_chars(void) {
    init_fb();
    return fb_info.height / fb_info.char_height;
}

void draw_rect(uint32_t x, uint32_t y, uint32_t width, uint32_t height, uint32_t color) {
    init_fb();

    for (uint32_t dy = 0; dy < height; dy++) {
        for (uint32_t dx = 0; dx < width; dx++) {
            put_pixel(x + dx, y + dy, color);
        }
    }
}

void draw_line(uint32_t x1, uint32_t y1, uint32_t x2, uint32_t y2, uint32_t color) {
    init_fb();

    int dx = (x2 > x1) ? (x2 - x1) : (x1 - x2);
    int dy = (y2 > y1) ? (y2 - y1) : (y1 - y2);
    int sx = (x1 < x2) ? 1 : -1;
    int sy = (y1 < y2) ? 1 : -1;
    int err = dx - dy;

    while (1) {
        put_pixel(x1, y1, color);
        if (x1 == x2 && y1 == y2) break;

        int e2 = 2 * err;
        if (e2 > -dy) {
            err -= dy;
            x1 += sx;
        }
        if (e2 < dx) {
            err += dx;
            y1 += sy;
        }
    }
}
